name: Sync All Forks

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch: 

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync all forked repositories
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          FORKS=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/user/repos?type=forks&per_page=100" | jq -r '.[].full_name')

          for REPO in $FORKS; do
            echo "Checking $REPO..."
    
            DEFAULT_BRANCH=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$REPO" | jq -r '.default_branch')

            RESPONSE=$(curl -s -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/merge-upstream" \
              -d "{\"branch\":\"$DEFAULT_BRANCH\"}")

            MESSAGE=$(echo $RESPONSE | jq -r '.message // "Success"')
            echo "Result for $REPO: $MESSAGE"
          done
